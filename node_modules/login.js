module.exports = function(req, res){
    var unixTime = Math.round((new Date()).getTime() / 1000);
    if(Math.abs(req.query.time - unixTime) > 60){//One minute tolerance
        res.jsonp({error:'Timeout'});
        return;
    }
    var crypto = require('crypto');
    var token = 'id=' + req.query.id + '&time=' + req.query.time + '&secret=' + global.config.secret;
    var myKey = crypto.createHash('md5').update(token).digest('hex');
    if(myKey != req.query.key){
        res.jsonp({error:'Key Error'});
        return;
    }
    req.session.host = {
        hostid: req.query.id,
        nick: req.query.nick
    };
    var rand = Math.floor(19201080*Math.random());
    var newToken = 'id=' + req.query.id + '&time=' + unixTime + '&rand=' + rand + '&secret=' + global.config.secret;
    var newKey = crypto.createHash('md5').update(newToken).digest('hex');
    res.jsonp({
        success:1,
        id:req.query.id,
        time:unixTime,
        rand:rand,
        key:newKey
    });
    console.log('UID ' + req.query.id + ' Login');
}
