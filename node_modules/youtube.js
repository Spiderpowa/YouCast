var broadcast = require('broadcast');
var BC = new broadcast.BroadCast({title:'Youtube'});
module.exports = function(req, res){
    var fn = youtube_none;
    switch(req.params.action){
        case 'host': fn = youtube_host; break;
        case 'view': fn = youtube_view; break;
        case 'touch': fn = youtube_touch; break;
        case 'active': fn = room_get_active; break;
    };
    fn(req, res);
}
function youtube_host(req, res){
    if(!check_host(req, res)){
        res.jsonp({error: ['Identity Error Or Login in other place'], relogin:1});
        return;
    }
    var host = req.session.host;
    var ytroom = BC.loadChannel(host.hostid, 3);
    console.log(host.hostid+' change ' + req.query.vid);
    ytroom.touch();
    ytroom.postMsg(host, "msg", req.query.vid);
    res.jsonp({info: ['Change Successfully']});
}
function youtube_view(req, res){
    if(!req.query.since){
        res.jsonp({error: ['No since value']});
        return;
    }
    var ytroom = BC.getChannel(req.query.hostid);
    if(ytroom == null){
        res.jsonp({error: ['Host Offline']});
        return;
    }
    var since = parseInt(req.query.since, 10);
    ytroom.readMsg(since, function(msgs){
        res.jsonp({message: msgs});
    });
}
function youtube_touch(req, res){
    if(!check_host(req, res)){
        res.jsonp({error: ['Identity Error Or Login in other place'], relogin:1});
        return;
    }
    var host = req.session.host;
    var ytroom = BC.loadChannel(host.hostid, 3);
    ytroom.touch();
    res.jsonp({info: ['Touched']});
}
function youtube_none(req, res){
    res.jsonp({error: 'Unknow Action'});
}
function room_get_active(req, res){
    var channels = BC.channels;
    var active = new Array();
    for(var key in channels){
        active.push(key);
    }
    res.jsonp({active:active});
}
function check_host(req, res){
    if(!req.session.host)
        return false;
    return true;
}
